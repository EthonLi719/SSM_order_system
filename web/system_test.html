<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ç³»ç»Ÿæ•´ä½“è”åŠ¨æ€§æµ‹è¯•</title>
    <script src="js/api-client.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; background: #f9f9f9; border-radius: 8px; }
        .result { background: #fff; padding: 10px; margin: 10px 0; border: 1px solid #ccc; white-space: pre-wrap; font-family: monospace; max-height: 300px; overflow-y: auto; }
        .success { background: #e6ffe6; border-color: #99cc99; }
        .error { background: #ffe6e6; border-color: #ff9999; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .summary { background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .test-result { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; }
        .test-pass { color: #28a745; }
        .test-fail { color: #dc3545; }
        .test-info { font-size: 0.9rem; color: #666; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”§ ç”µå•†ç®¡ç†ç³»ç»Ÿ - æ•´ä½“è”åŠ¨æ€§æµ‹è¯•</h1>
        <p>æµ‹è¯•æ‰€æœ‰ç»„ä»¶çš„åä½œèƒ½åŠ›å’Œæ•°æ®æµè½¬</p>
    </div>

    <div class="summary" id="summary">
        <h3>ğŸ“Š æµ‹è¯•æ¦‚è§ˆ</h3>
        <div id="testOverview">
            <p>ç‚¹å‡»"å¼€å§‹å…¨é¢æµ‹è¯•"æŒ‰é’®å¼€å§‹ç³»ç»Ÿæµ‹è¯•...</p>
        </div>
    </div>

    <div class="grid">
        <div class="test-section">
            <h2>ğŸ—ï¸ åŸºç¡€æ¶æ„æµ‹è¯•</h2>
            <button onclick="testBasicArchitecture()">æµ‹è¯•åŸºç¡€æ¶æ„</button>
            <div id="archResults" class="result">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <h2>ğŸ“¦ å•†å“ç³»ç»Ÿæµ‹è¯•</h2>
            <button onclick="testProductSystem()">æµ‹è¯•å•†å“ç³»ç»Ÿ</button>
            <div id="productResults" class="result">ç­‰å¾…æµ‹è¯•...</div>
        </div>
    </div>

    <div class="grid">
        <div class="test-section">
            <h2>ğŸ“‹ è®¢å•ç³»ç»Ÿæµ‹è¯•</h2>
            <button onclick="testOrderSystem()">æµ‹è¯•è®¢å•ç³»ç»Ÿ</button>
            <div id="orderResults" class="result">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <h2>ğŸ”— è·¨ç³»ç»Ÿé›†æˆæµ‹è¯•</h2>
            <button onclick="testIntegration()">æµ‹è¯•ç³»ç»Ÿé›†æˆ</button>
            <div id="integrationResults" class="result">ç­‰å¾…æµ‹è¯•...</div>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸš€ æ€§èƒ½å’Œé”™è¯¯å¤„ç†æµ‹è¯•</h2>
        <button onclick="testPerformance()">æ€§èƒ½æµ‹è¯•</button>
        <button onclick="testErrorHandling()">é”™è¯¯å¤„ç†æµ‹è¯•</button>
        <button onclick="testFullSystem()" class="btn-success">å¼€å§‹å…¨é¢æµ‹è¯•</button>
        <div id="performanceResults" class="result">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <div class="test-section">
        <h2>ğŸ“ˆ å®æ—¶çŠ¶æ€ç›‘æ§</h2>
        <div id="realTimeStatus" class="status">
            <p>ç­‰å¾…æµ‹è¯•å¼€å§‹...</p>
        </div>
        <button onclick="clearStatus()">æ¸…é™¤çŠ¶æ€</button>
    </div>

    <script>
        let testResults = {
            architecture: {},
            product: {},
            order: {},
            integration: {},
            performance: {},
            error: {}
        };

        let testStartTime = null;

        // åŸºç¡€æ¶æ„æµ‹è¯•
        async function testBasicArchitecture() {
            updateStatus('å¼€å§‹åŸºç¡€æ¶æ„æµ‹è¯•...', 'info');
            const resultsDiv = document.getElementById('archResults');
            resultsDiv.textContent = 'æ­£åœ¨æµ‹è¯•åŸºç¡€æ¶æ„...';

            const tests = [
                { name: 'APIå®¢æˆ·ç«¯åŠ è½½', test: () => typeof apiClient !== 'undefined' },
                { name: 'HTMLé¡µé¢åŠ è½½', test: () => document.readyState === 'complete' },
                { name: 'JavaScriptæ”¯æŒ', test: () => typeof Promise !== 'undefined' },
                { name: 'Fetch APIæ”¯æŒ', test: () => typeof fetch !== 'undefined' }
            ];

            let results = [];
            for (const test of tests) {
                try {
                    const result = test.test();
                    results.push({ name: test.name, success: result, error: null });
                } catch (error) {
                    results.push({ name: test.name, success: false, error: error.message });
                }
            }

            testResults.architecture = results;
            displayTestResults('archResults', results, 'åŸºç¡€æ¶æ„æµ‹è¯•');
            updateStatus('åŸºç¡€æ¶æ„æµ‹è¯•å®Œæˆ', 'success');
        }

        // å•†å“ç³»ç»Ÿæµ‹è¯•
        async function testProductSystem() {
            updateStatus('å¼€å§‹å•†å“ç³»ç»Ÿæµ‹è¯•...', 'info');
            const resultsDiv = document.getElementById('productResults');
            resultsDiv.textContent = 'æ­£åœ¨æµ‹è¯•å•†å“ç³»ç»Ÿ...';

            const tests = [
                {
                    name: 'å•†å“APIè·¯å¾„æµ‹è¯•',
                    test: async () => {
                        const urls = ['/product/list', '/product/api/list', '/product/products'];
                        const results = [];

                        for (const url of urls) {
                            try {
                                const response = await apiClient.request(url);
                                results.push({ url: url, success: response.code === 200 });
                            } catch (error) {
                                results.push({ url: url, success: false, error: error.message });
                            }
                        }
                        return results;
                    }
                },
                {
                    name: 'å•†å“æ•°æ®æŸ¥è¯¢',
                    test: async () => {
                        const response = await apiClient.safeRequest(() => apiClient.getProducts());
                        return response.code === 200 && response.data;
                    }
                },
                {
                    name: 'å•†å“åˆ†ç±»æŸ¥è¯¢',
                    test: async () => {
                        const response = await apiClient.safeRequest(() => apiClient.getProductsByCategory('ç”µå­äº§å“'));
                        return response.code === 200;
                    }
                }
            ];

            let results = [];
            for (const test of tests) {
                try {
                    const result = await test.test();
                    results.push({ name: test.name, success: true, result: result });
                } catch (error) {
                    results.push({ name: test.name, success: false, error: error.message });
                }
            }

            testResults.product = results;
            displayTestResults('productResults', results, 'å•†å“ç³»ç»Ÿæµ‹è¯•');
            updateStatus('å•†å“ç³»ç»Ÿæµ‹è¯•å®Œæˆ', 'success');
        }

        // è®¢å•ç³»ç»Ÿæµ‹è¯•
        async function testOrderSystem() {
            updateStatus('å¼€å§‹è®¢å•ç³»ç»Ÿæµ‹è¯•...', 'info');
            const resultsDiv = document.getElementById('orderResults');
            resultsDiv.textContent = 'æ­£åœ¨æµ‹è¯•è®¢å•ç³»ç»Ÿ...';

            const tests = [
                {
                    name: 'è®¢å•APIè·¯å¾„æµ‹è¯•',
                    test: async () => {
                        const urls = ['/order/list', '/order/api/list', '/order/orders'];
                        const results = [];

                        for (const url of urls) {
                            try {
                                const response = await apiClient.request(url);
                                results.push({ url: url, success: response.code === 200 });
                            } catch (error) {
                                results.push({ url: url, success: false, error: error.message });
                            }
                        }
                        return results;
                    }
                },
                {
                    name: 'è®¢å•æ•°æ®æŸ¥è¯¢',
                    test: async () => {
                        const response = await apiClient.safeRequest(() => apiClient.getOrders());
                        return response.code === 200 && response.data;
                    }
                },
                {
                    name: 'è®¢å•çŠ¶æ€æŸ¥è¯¢',
                    test: async () => {
                        const response = await apiClient.safeRequest(() => apiClient.getOrdersByStatus('pending'));
                        return response.code === 200;
                    }
                }
            ];

            let results = [];
            for (const test of tests) {
                try {
                    const result = await test.test();
                    results.push({ name: test.name, success: true, result: result });
                } catch (error) {
                    results.push({ name: test.name, success: false, error: error.message });
                }
            }

            testResults.order = results;
            displayTestResults('orderResults', results, 'è®¢å•ç³»ç»Ÿæµ‹è¯•');
            updateStatus('è®¢å•ç³»ç»Ÿæµ‹è¯•å®Œæˆ', 'success');
        }

        // ç³»ç»Ÿé›†æˆæµ‹è¯•
        async function testIntegration() {
            updateStatus('å¼€å§‹ç³»ç»Ÿé›†æˆæµ‹è¯•...', 'info');
            const resultsDiv = document.getElementById('integrationResults');
            resultsDiv.textContent = 'æ­£åœ¨æµ‹è¯•ç³»ç»Ÿé›†æˆ...';

            const tests = [
                {
                    name: 'å•†å“-è®¢å•æ•°æ®æµè½¬',
                    test: async () => {
                        // å…ˆè·å–å•†å“ï¼Œç„¶ååˆ›å»ºè®¢å•çš„æ¦‚å¿µæµ‹è¯•
                        const products = await apiClient.safeRequest(() => apiClient.getProducts());
                        const orders = await apiClient.safeRequest(() => apiClient.getOrders());

                        return {
                            productsAvailable: products.code === 200 && products.data && products.data.length > 0,
                            ordersAvailable: orders.code === 200 && orders.data,
                            dataIntegrity: products.code === 200 && orders.code === 200
                        };
                    }
                },
                {
                    name: 'å¤šè·¯å¾„ä¸€è‡´æ€§',
                    test: () => {
                        const productPaths = ['/product/list', '/product/api/list'];
                        const orderPaths = ['/order/list', '/order/api/list'];

                        return {
                            productConsistent: productPaths.length > 1,
                            orderConsistent: orderPaths.length > 1,
                            totalPaths: productPaths.length + orderPaths.length
                        };
                    }
                }
            ];

            let results = [];
            for (const test of tests) {
                try {
                    const result = await test.test();
                    results.push({ name: test.name, success: true, result: result });
                } catch (error) {
                    results.push({ name: test.name, success: false, error: error.message });
                }
            }

            testResults.integration = results;
            displayTestResults('integrationResults', results, 'ç³»ç»Ÿé›†æˆæµ‹è¯•');
            updateStatus('ç³»ç»Ÿé›†æˆæµ‹è¯•å®Œæˆ', 'success');
        }

        // æ€§èƒ½æµ‹è¯•
        async function testPerformance() {
            updateStatus('å¼€å§‹æ€§èƒ½æµ‹è¯•...', 'info');
            const resultsDiv = document.getElementById('performanceResults');
            resultsDiv.textContent = 'æ­£åœ¨è¿›è¡Œæ€§èƒ½æµ‹è¯•...';

            const startTime = performance.now();
            const testCount = 10;
            const results = [];

            for (let i = 0; i < testCount; i++) {
                const requestStart = performance.now();
                try {
                    const response = await apiClient.safeRequest(() => apiClient.getProducts());
                    const requestEnd = performance.now();

                    results.push({
                        iteration: i + 1,
                        success: response.code === 200,
                        responseTime: requestEnd - requestStart,
                        dataSize: response.data ? response.data.length : 0
                    });
                } catch (error) {
                    results.push({
                        iteration: i + 1,
                        success: false,
                        error: error.message,
                        responseTime: 0
                    });
                }
            }

            const endTime = performance.now();
            const totalTime = endTime - startTime;

            const successCount = results.filter(r => r.success).length;
            const avgResponseTime = results.reduce((sum, r) => sum + r.responseTime, 0) / results.length;
            const maxResponseTime = Math.max(...results.map(r => r.responseTime));
            const minResponseTime = Math.min(...results.map(r => r.responseTime));

            testResults.performance = {
                totalTime,
                avgResponseTime,
                maxResponseTime,
                minResponseTime,
                successRate: (successCount / testCount) * 100,
                results
            };

            resultsDiv.innerHTML = `
                <strong>æ€§èƒ½æµ‹è¯•ç»“æœ:</strong><br>
                æ€»æ—¶é—´: ${totalTime.toFixed(2)}ms<br>
                æˆåŠŸç‡: ${testResults.performance.successRate.toFixed(1)}%<br>
                å¹³å‡å“åº”æ—¶é—´: ${avgResponseTime.toFixed(2)}ms<br>
                æœ€å¤§å“åº”æ—¶é—´: ${maxResponseTime.toFixed(2)}ms<br>
                æœ€å°å“åº”æ—¶é—´: ${minResponseTime.toFixed(2)}ms<br>
                <details>
                    <summary>è¯¦ç»†ç»“æœ</summary>
                    <pre>${JSON.stringify(results, null, 2)}</pre>
                </details>
            `;

            updateStatus('æ€§èƒ½æµ‹è¯•å®Œæˆ', 'success');
        }

        // é”™è¯¯å¤„ç†æµ‹è¯•
        async function testErrorHandling() {
            updateStatus('å¼€å§‹é”™è¯¯å¤„ç†æµ‹è¯•...', 'info');
            const resultsDiv = document.getElementById('performanceResults');

            const errorTests = [
                {
                    name: 'æ— æ•ˆè·¯å¾„æµ‹è¯•',
                    test: async () => {
                        try {
                            await apiClient.request('/product/invalid/path');
                            return false;
                        } catch (error) {
                            return true;
                        }
                    }
                },
                {
                    name: 'é”™è¯¯æ¢å¤æµ‹è¯•',
                    test: async () => {
                        const response = await apiClient.safeRequest(
                            () => apiClient.request('/product/nonexistent'),
                            'é¢„æœŸé”™è¯¯'
                        );
                        return response.code === 500;
                    }
                }
            ];

            let errorResults = [];
            for (const test of errorTests) {
                try {
                    const result = await test.test();
                    errorResults.push({ name: test.name, success: result });
                } catch (error) {
                    errorResults.push({ name: test.name, success: false, error: error.message });
                }
            }

            const allPassed = errorResults.every(r => r.success);
            resultsDiv.innerHTML += `
                <strong>é”™è¯¯å¤„ç†æµ‹è¯•ç»“æœ:</strong><br>
                çŠ¶æ€: ${allPassed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}<br>
                <pre>${JSON.stringify(errorResults, null, 2)}</pre>
            `;

            updateStatus('é”™è¯¯å¤„ç†æµ‹è¯•å®Œæˆ', allPassed ? 'success' : 'error');
        }

        // å…¨é¢ç³»ç»Ÿæµ‹è¯•
        async function testFullSystem() {
            updateStatus('å¼€å§‹å…¨é¢ç³»ç»Ÿæµ‹è¯•...', 'info');
            testStartTime = performance.now();

            await testBasicArchitecture();
            await testProductSystem();
            await testOrderSystem();
            await testIntegration();
            await testPerformance();
            await testErrorHandling();

            const endTime = performance.now();
            const totalTime = (endTime - testStartTime) / 1000;

            // ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
            generateFinalReport(totalTime);
            updateStatus('å…¨é¢ç³»ç»Ÿæµ‹è¯•å®Œæˆï¼', 'success');
        }

        // ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
        function generateFinalReport(totalTime) {
            const summaryDiv = document.getElementById('testOverview');

            const calculateSuccessRate = (results) => {
                if (!results || results.length === 0) return 0;
                const passed = results.filter(r => r.success).length;
                return (passed / results.length * 100).toFixed(1);
            };

            const archSuccess = calculateSuccessRate(testResults.architecture);
            const productSuccess = calculateSuccessRate(testResults.product);
            const orderSuccess = calculateSuccessRate(testResults.order);
            const integrationSuccess = calculateSuccessRate(testResults.integration);

            summaryDiv.innerHTML = `
                <div class="test-result">
                    <span class="test-pass">âœ… åŸºç¡€æ¶æ„: ${archSuccess}%</span>
                    <span class="test-info">|</span>
                    <span class="test-pass">ğŸ“¦ å•†å“ç³»ç»Ÿ: ${productSuccess}%</span>
                    <span class="test-info">|</span>
                    <span class="test-pass">ğŸ“‹ è®¢å•ç³»ç»Ÿ: ${orderSuccess}%</span>
                    <span class="test-info">|</span>
                    <span class="test-pass">ğŸ”— ç³»ç»Ÿé›†æˆ: ${integrationSuccess}%</span>
                </div>
                <div class="test-result">
                    <strong>â±ï¸ æ€»æµ‹è¯•æ—¶é—´:</strong> ${totalTime.toFixed(2)}ç§’
                </div>
                <div class="test-result">
                    <strong>ğŸ¯ æ•´ä½“çŠ¶æ€:</strong> ${
                        archSuccess >= 75 && productSuccess >= 75 && orderSuccess >= 75 && integrationSuccess >= 75
                        ? '<span class="test-pass">âœ… ç³»ç»Ÿè¿è¡Œæ­£å¸¸</span>'
                        : '<span class="test-fail">âŒ éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥</span>'
                    }
                </div>
                <div style="margin-top: 20px;">
                    <button onclick="window.location.reload()" class="btn-danger">ğŸ”„ é‡æ–°æµ‹è¯•</button>
                    <button onclick="window.open('/product/list_improved.jsp', '_blank')" class="btn-success">ğŸ›’ï¸ è®¿é—®å•†å“é¡µé¢</button>
                    <button onclick="window.open('/order/manage', '_blank')" class="btn-primary">ğŸ“‹ è®¿é—®è®¢å•é¡µé¢</button>
                </div>
            `;
        }

        // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        function displayTestResults(elementId, results, testName) {
            const element = document.getElementById(elementId);
            const successCount = results.filter(r => r.success).length;
            const successRate = (successCount / results.length * 100).toFixed(1);
            const status = successCount === results.length ? 'success' : 'error';

            element.className = `result ${status}`;
            element.innerHTML = `
                <strong>${testName}:</strong><br>
                æˆåŠŸç‡: ${successRate}% (${successCount}/${results.length})<br>
                <details>
                    <summary>è¯¦ç»†ä¿¡æ¯</summary>
                    <pre>${JSON.stringify(results, null, 2)}</pre>
                </details>
            `;
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('realTimeStatus');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = `
                <strong>${new Date().toLocaleTimeString()}</strong><br>
                ${message}
            `;
        }

        // æ¸…é™¤çŠ¶æ€
        function clearStatus() {
            const statusDiv = document.getElementById('realTimeStatus');
            statusDiv.innerHTML = '<p>çŠ¶æ€å·²æ¸…é™¤</p>';
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ç³»ç»Ÿæµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            updateStatus('ç³»ç»Ÿæµ‹è¯•é¡µé¢å·²å‡†å¤‡å°±ç»ª', 'info');
        });
    </script>
</body>
</html>